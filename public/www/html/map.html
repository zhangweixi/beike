<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}

		#allmap{
			height:90vh;
		}

	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=zZSGyxZgUytdiKG135BcnaP6"></script>
	<title>折线上添加方向箭头</title>
	<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
<div id="allmap"></div>

<button onclick="add_overlay();">添加图标</button>
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");    // 创建Map实例
    map.centerAndZoom(new BMap.Point(121.41971366666668,31.147523000000003), 14);  // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
        scale: 0.6,//图标缩放大小
        strokeColor:'#fff',//设置矢量图标的线填充颜色
        strokeWeight: '2',//设置线宽
    });
    var icons = new BMap.IconSequence(sy, '10', '30');

    // 创建polyline对象




    var pois = [
        new BMap.Point(116.350658,39.938285),
        new BMap.Point(116.386446,39.939281),
        new BMap.Point(116.389034,39.913828),
        new BMap.Point(116.442501,39.914603)
    ];



	console.log('pois=');
    console.log(pois);


    //添加覆盖物
    function add_overlay(){

        var url = "/gps-111.json";

        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {

                data = JSON.parse(data);
                var length = data.lat.length;

                var lats = data.lat;
                var lons = data.lon;
                var points = [];

                var templon = 0;
                var templat = 0;
				var str = "";

                for(var i =0;i<length ;i++){

                    if(lons[i] == "") continue;

                    templat = gps_to_gps(lats[i]);
                    templon = gps_to_gps(lons[i]);
                    //console.log(lats[i]+","+ lons[i]);
                    //console.log(templat+","+templon);
					str += templon+","+templat+";";

					//map.addOverlay(new BMap.Marker(new BMap.Point(templon,templat)));

					if(points.length % 100 == 0)
					{

                        var url = "http://api.map.baidu.com/geoconv/v1/?coords="+str+"&from=1&to=5&ak=zZSGyxZgUytdiKG135BcnaP6";
                        str = "";

                        $.get(url).success(function(res){
                            console.log(data);
						})
					}

                    points.push(new BMap.Point(templon,templat));
                }


                console.log(points.length);

                var convertor = new BMap.Convertor();
                var pointArr = [];
					pointArr.push(points);

                	convertor.translate(points, 1, 5, translateCallback)



				console.log(points);
                var polyline =new BMap.Polyline(pois, {
                    enableEditing: false,//是否启用线编辑，默认为false
                    enableClicking: true,//是否响应点击事件，默认为true
                    icons:[icons],
                    strokeWeight:'8',//折线的宽度，以像素为单位
                    strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
                    strokeColor:"#18a45b" //折线颜色
                });


                //map.addOverlay(polyline);          //增加折线

            }
        });
    }

    //坐标转换完之后的回调函数
    translateCallback = function (data){
        console.log(data);
        if(data.status === 0) {
            for(var p of data.points)
			{
			    console.log(p);
                var marker = new BMap.Marker(p);
                map.addOverlay(marker);
			}


            //var label = new BMap.Label("转换后的百度坐标（正确）",{offset:new BMap.Size(20,-10)});
            //marker.setLabel(label); //添加百度label
            //map.setCenter(data.points[0]);
        }
    }


/*
    var polyline =new BMap.Polyline(pois, {
        enableEditing: false,//是否启用线编辑，默认为false
        enableClicking: true,//是否响应点击事件，默认为true
        icons:[icons],
        strokeWeight:'8',//折线的宽度，以像素为单位
        strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
        strokeColor:"#18a45b" //折线颜色
    });*/

    //map.addOverlay(polyline);          //增加折线

    function gps_to_gps(gps)
    {
        var temp = gps/100;

        return toDecimal2(parseInt(temp) + temp % 1/60*100,6);
    }


    function toDecimal2(val,len) {
        //debugger;
        var f = parseFloat(val);
        if (isNaN(f)) {
            return false;
        }
        var f = Math.round(val*Math.pow(10,len))/Math.pow(10,len);
        var s = f.toString();
        var rs = s.indexOf('.');
        if (rs < 0) {
            rs = s.length;
            s += '.';
        }
        while (s.length <= rs + len) {
            s += '0';
        }
        return s;
    }

</script>