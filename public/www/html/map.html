<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}

		#allmap{
			height:90vh;
		}

	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=zZSGyxZgUytdiKG135BcnaP6"></script>
	<title>折线上添加方向箭头</title>
	<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
</head>
<body>
<div id="allmap"></div>


<div>
	<button onclick="add_overlay();">显示所有点</button>
	<button onclick="show_distance()">显示最大点</button>
	<label for="">纬度距离：<span id="wei"></span></label>
	<label for="">经度距离：<span id="jin"></span></label>
</div>

</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");    // 创建Map实例
    map.centerAndZoom("上海",16);  //初始化地图,设置城市和地图级别。
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放

    var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
        scale: 0.6,//图标缩放大小
        strokeColor:'#fff',//设置矢量图标的线填充颜色
        strokeWeight: '2',//设置线宽
    });
    var icons = new BMap.IconSequence(sy, '10', '30');

    // 创建polyline对象


	if(0)
	{
	    //正常
		var pois = [
			new BMap.Point(116.350658,39.938285),
			new BMap.Point(116.386446,39.939281),
			new BMap.Point(116.389034,39.913828),
			new BMap.Point(116.442501,39.914603)
		];


		//出错
        var pois = [
            new BMap.Point(120.409182,31.1736545),
            new BMap.Point(120.409182,31.1736556),
            new BMap.Point(120.409183,31.1736564),
            new BMap.Point(120.409184,31.1736575)
        ];
        console.log('pois=');
        console.log(pois);
		var polyline =new BMap.Polyline(pois, {
			enableEditing: false,//是否启用线编辑，默认为false
			enableClicking: true,//是否响应点击事件，默认为true
			icons:[icons],
			strokeWeight:'8',//折线的宽度，以像素为单位
			strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
			strokeColor:"#18a45b" //折线颜色
		});
    	map.addOverlay(polyline);          //增加折线
	}




    //添加覆盖物
    function add_overlay(){

		var matchId	= getQueryVariable('matchId');
		if(matchId < 0)
		{
		    alert('缺少matchId');
		    return ;
		}

        var url = "/api/v1/match/baidu_map?matchId="+matchId+"&fresh="+getQueryVariable('fresh');
        //var url = "http://dev1.api.launchever.cn/www/html/map.html";

        $.ajax({
            url: url,
            type: "POST",
            success: function (res) {

                //data = JSON.parse(data);
				var data	= res.data.points;

                var points = [];

                for(var p in data){

					var newp = new BMap.Point(data[p].x,data[p].y);
                    points.push(newp);

                    //map.addOverlay(new BMap.Marker(newp));
                }

                var options = {
                    size: BMAP_POINT_SIZE_SMALL,
                    shape: BMAP_POINT_SHAPE_STAR,
                    color: '#d340c3'
                }

                var pointCollection = new BMap.PointCollection(points, options);  // 初始化PointCollection
                //pointCollection.addEventListener('click', function (

                map.addOverlay(pointCollection);  // 添加Overlay

				//console.log(points);

                var polyline =new BMap.Polyline(points, {
                    enableEditing: false,//是否启用线编辑，默认为false
                    enableClicking: true,//是否响应点击事件，默认为true
                    icons:[icons],
                    strokeWeight:'8',//折线的宽度，以像素为单位
                    strokeOpacity: 0.8,//折线的透明度，取值范围0 - 1
                    strokeColor:"#18a45b" //折线颜色
                });


                //map.addOverlay(polyline);          //增加折线

            }
        });
    }


    function getQueryVariable(variable)
    {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return(false);
    }



    function show_distance()
    {
        var matchId = getQueryVariable('matchId');
        if(!matchId)
        {
            alert('缺少matchId');
            return ;
        }
        var url = "/api/v1/test/maxDistance?matchId="+matchId+"&isgps="+getQueryVariable('isgps');

        $.get(url).success(function(res){

            if(res.code != 200)
            {
                alert(res.message);
                return ;
            }

            var points  = res.data.points;

            for(var p in points)
            {

                console.log(points[p].lon+","+points[p].lat);
            }
            //最大最小维度
            var minLat  = points.minLat;
            var maxLat  = points.maxLat;

            minLat      = getpoint(minLat.lat,minLat.lon);
            maxLat      = getpoint(maxLat.lat,maxLat.lon);

            map.centerAndZoom(minLat,20);  //初始化地图,设置城市和地图级别。

            //最大最小经度

            var minLon  = points.minLon;
            var maxLon  = points.maxLon;

            minLon      = getpoint(minLon.lat,minLon.lon);
            maxLon      = getpoint(maxLon.lat,maxLon.lon);

            drawline(minLat,maxLat);

            console.log('最大最小维度:');
            var dis = get_distance(minLat,maxLat);
            $('#wei').text(dis);


            drawline(minLon,maxLon);
            console.log('最大最小经度:');
            dis = get_distance(minLon,maxLon);
            $('#jin').text(dis);

        });
    }

    function drawline(pointA,pointB)
    {
        var polyline = new BMap.Polyline([pointA,pointB], {strokeColor:"green", strokeWeight:6, strokeOpacity:0.5});  //定义折线
        map.addOverlay(polyline);     //添加折线到地图上
    }



    function get_distance(pointA,pointB)
    {

        var dis = map.getDistance(pointA,pointB);
        return dis;
    }

    function getpoint(lat,lon)
    {
        return new BMap.Point(lon,lat);
    }


</script>